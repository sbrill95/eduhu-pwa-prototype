<!DOCTYPE html>
<html>
<head>
    <title>Agent Integration Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        .success { color: green; }
        .error { color: red; }
        .pending { color: orange; }
        button { padding: 10px 20px; margin: 5px; }
        textarea { width: 100%; height: 60px; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>LangGraph Agent Integration Test</h1>

    <div class="test-section">
        <h2>1. Backend API Test</h2>
        <button onclick="testBackendHealth()">Test Backend Health</button>
        <button onclick="testAgentAvailable()">Test Agents Available</button>
        <div id="backend-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>2. Agent Detection Test</h2>
        <textarea id="test-input" placeholder="Geben Sie hier eine Nachricht ein zum Testen der Agent-Erkennung...">Erstelle ein Bild von einem Löwen für den Biologie-Unterricht</textarea><br>
        <button onclick="testAgentDetection()">Test Agent Detection</button>
        <div id="detection-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>3. Frontend Integration Test</h2>
        <p>Öffnen Sie die Frontend-Anwendung in einem neuen Tab: <a href="http://localhost:5173" target="_blank">http://localhost:5173</a></p>
        <p>Testen Sie die Eingabe: <strong>"Erstelle ein Bild von einem Löwen"</strong></p>
        <p>Erwartetes Verhalten:</p>
        <ul>
            <li>Agent-Erkennung wird ausgelöst</li>
            <li>Bestätigungsmodal erscheint</li>
            <li>Nach Bestätigung wird der Progress-Balken angezeigt</li>
            <li>Bild wird in Chat integriert</li>
        </ul>
    </div>

    <script>
        const API_BASE = 'http://localhost:3006/api';

        async function testBackendHealth() {
            const result = document.getElementById('backend-result');
            result.innerHTML = '<span class="pending">Testing backend health...</span>';

            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();

                if (data.success) {
                    result.innerHTML = `<span class="success">✅ Backend healthy: ${data.message}</span>`;
                } else {
                    result.innerHTML = `<span class="error">❌ Backend unhealthy: ${data.error}</span>`;
                }
            } catch (error) {
                result.innerHTML = `<span class="error">❌ Backend connection failed: ${error.message}</span>`;
            }
        }

        async function testAgentAvailable() {
            const result = document.getElementById('backend-result');
            result.innerHTML += '<br><span class="pending">Testing agent endpoints...</span>';

            try {
                // Test the exact path that frontend uses
                const response = await fetch(`${API_BASE}/langgraph/agents/available`);
                const data = await response.json();

                if (data.success) {
                    result.innerHTML += `<br><span class="success">✅ Agents endpoint working: ${data.data.agents.length} agents available</span>`;
                    result.innerHTML += `<br><pre>${JSON.stringify(data.data, null, 2)}</pre>`;
                } else {
                    result.innerHTML += `<br><span class="error">❌ Agents endpoint failed: ${data.error}</span>`;
                }
            } catch (error) {
                result.innerHTML += `<br><span class="error">❌ Agents endpoint connection failed: ${error.message}</span>`;
            }
        }

        function testAgentDetection() {
            const input = document.getElementById('test-input').value;
            const result = document.getElementById('detection-result');

            // Simulate the frontend agent detection logic
            const normalizedInput = input.toLowerCase().trim();

            const imageKeywords = [
                'bild', 'bilder', 'erstellen', 'generieren', 'zeichnung', 'zeichnen',
                'grafik', 'illustration', 'visual', 'visuell', 'erstelle',
                'generiere', 'zeichne', 'male', 'skizze', 'löwe', 'tier'
            ];

            const imageMatches = imageKeywords.filter(keyword =>
                normalizedInput.includes(keyword)
            );

            let confidence = 0;
            if (imageMatches.length > 0) {
                confidence = Math.min(imageMatches.length * 0.25 + 0.3, 0.9);

                // Check for strong indicators
                const strongIndicators = ['erstelle ein bild', 'generiere', 'zeichne', 'mach mir ein'];
                const hasStrongIndicator = strongIndicators.some(indicator =>
                    normalizedInput.includes(indicator)
                );

                if (hasStrongIndicator) {
                    confidence = Math.min(confidence + 0.3, 1.0);
                }
            }

            const detected = confidence >= 0.4;

            if (detected) {
                result.innerHTML = `
                    <span class="success">✅ Agent Detection Successful</span><br>
                    <strong>Confidence:</strong> ${(confidence * 100).toFixed(1)}%<br>
                    <strong>Matched Keywords:</strong> ${imageMatches.join(', ')}<br>
                    <strong>Agent ID:</strong> image-generation<br>
                    <strong>Action:</strong> Ein Bild basierend auf Ihrer Beschreibung erstellen<br>
                `;
            } else {
                result.innerHTML = `
                    <span class="error">❌ No Agent Detected</span><br>
                    <strong>Confidence:</strong> ${(confidence * 100).toFixed(1)}%<br>
                    <strong>Matched Keywords:</strong> ${imageMatches.join(', ') || 'none'}<br>
                `;
            }
        }

        // Auto-test on load
        window.onload = function() {
            testBackendHealth();
            setTimeout(testAgentAvailable, 1000);
        };
    </script>
</body>
</html>